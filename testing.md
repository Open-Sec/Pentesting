# TESTING (PROBANDO)

En esta etapa se recibe toda la información generada en el **SCANNING** y se procede a ejecutar acciones que permitan realizar, al menos, una Penetración.
Entendamos por penetración la acción que permite :
- A nivel de Infraestructura Externa : ejecutar comandos a nivel de usuario sin privilegios y/o con privilegios en un target expuesto hacia Internet.
- A nivel de Infraestructura Interna : ejecutar comandos a nivel de usuario sin privilegios y/o con privilegios en un target expuesto en la red interna o privada.
- A nivel de aplicaciones : conseguir explotar una vulnerabildiad que conduzca al acceso no autorizado a una funcionalidad o data específica o que permita utilizar la aplicación como un medio para elaborar otro tipo de ataques donde el objetivo sea la misma aplicación, otra aplicación, la infraestructura que soporta la aplicación o los usuarios de la aplicación.

Esta etapa considera dos módulos que son los que comunmente conducen a la penetración : Probar con exploits y/o Probar con credenciales.
En ambos casos, esto puede referirse al uso de algun programa (exploit) o técnica de explotación (como cuando se explota una vulnerabilidad en un API mediante la alteración de los requests y/o responses).

Esta etapa permite ejecutar acciones que han sido evaluadas y diseñadas en la etapa anterior y, por ende, permite obtener resultados que ayudan en el análisis de la criticidad de las vulnerabilidades.
Sin embargo, los pasos adicionales de Escalamiento de Privilegios permiten obtener resultados que determinan niveles de criticada mayores y la posibilidad de expandir la Penetración realizada con el objetivo de obtener acceso a data privilegiada o funcionalidades privilegiadas o información confidencial o, incluso, hasta tomar el control total de un componente completo de los servicios de infraestructura (como conseguir DA en el AD) o acceso arbitrario y total a la data manejada por una aplicación (incluso a la data de aplicaciones relacionadas o que comparten recursos [ como ocurre en varios SaaS ] ).

## Test with Exploits (Probando con Exploits)

El concepto de exploit ha variado mucho y cada vez resulta más complicado emplear este término. 
Apartándose de la terminología estricta, consideremos exploit a un programa que permita realizar acciones no permitidas a través de un servicio de infraestructura o de una aplicación. 
Este programa puede haber recibido la denominación de PoC (Proof of Concept) o una secuencia de pasos que se han documentado y que permiten obtener el mismo efecto de un programa que automatiza la acción de explotación.

Es muy común el empleo de exploits a nivel de servicios de infraestructura (a nivel de servidores y/o clientes) y no existe una fuente que sea completamente confiable para obtenerlos.  Por ejemplo, frameworks ampliamente reconocidos como MetaSploit fueron victimas indirectas de ataques a la organización que lo desarrollaba (los reportes del 2008 y 2013 indican que no fue afectado release alguno).
Por ello, es obligación de los pentesters el comprobar con antelación la validez del exploit que se esta usando y es ahi donde un trabajo en equipo resulta importante porque no todo pentester puede tener los conocimientos y experiencia requeridos para ello, es parte de la especialización.

En el caso de aplicaciones, lo más común es que se emplean técnicas de explotación y algunos programas que se emplean no son exploits si no programas de ayuda.
Por ejemplo, para la explotación de vulnerabilidades de deserialización, una herramienta como Ysoreial solamente ayuda a "combinar" un conjunto de funcionalidades en librerías de uso común.  Estas funcionalidades o gadgets encadenados tienen efectos secundarios que son usados para explotar vulnerabilidades de deserialización que son creadas en aplicaciones mal hechas en el aspecto de seguridad.  Por ende, Ysoserial podría ser usado incluso hasta en labores administrativas permitidas como un "helper".

Otro aspecto importante que debe ser comprendido es que durante un pentest no hay tiempo para desarrollar exploits nuevos.
Aunque es factible que durante un pentest, el pentester encuentre una vulnerabilidad no reportada por alguien anteriormente, una explotación automatizada puede ser obtenida, pero, en la forma de un PoC, es decir, una automatización que solamente es útil para el contexto evaluado durante el pentest en particular (contexto que varíá por versiones de software, niveles de parchado, configuración específica, condiciones de tiempo disponible, condiciones de la conectividad, etc.)

## Test with Credentials (Probar con Credenciales)
obtencion
reuso
crackeo
ataque de diccionario a infra, apps, APIs

## Penetration (Penetración)

La Penetración, una vez obtenida, determina elementos que deben permitir 

- Establecimiento : la penetración debe ser firme en el sentido que debe poder ser accionada una cantidad indeterminada de veces. Algunas condiciones pueden impedirlo como el contexto o el hecho que puedan conducir a DoS. El establecimiento puede incluir el uso de técnicas que permitan realizar evasión de protecciones de red (como la segmentación y/o XDR) o EDRs o IPSs o WAFs o simples anti-virus.
- Pivotear : la penetración debe permitir usar la victima explotada adecuadamente como un trampolin hacia otros activos de información y/o hosts (de forma estricta, debería ser unicamente a los targets en el alcance, pero, existen condiciones donde no revelar el uso indebido de algun host representaría un riesgo sin reportar). 
- Exfiltración : la penetración debe analizar formas de extraer datos hacia un equipo controlado por el pentester y hacer uso de los protocolos de red disponibles y permitidos.
- Persistencia : los cambios de estado operacional no deben constituir un impedimento para mantener el acceso obtenido mediante la penetración. Por ejemplo, el reinicio del target no debería implicar que se pierda el acceso.  Este tipo de condiciones son obtenidas a partir del escalamiento de privilegios, comunmente.

Todo esto puede ser factible o no y dependerá de los controles de seguridad a nivel de infraestructura y/oaplicaciones. Al igual que ocurre con la evasión de protecciones, la imposibilidad debe ser documentada y reportada a nivel ejecutivo (el detalle técnico puede ser solicitado por la organización evaluada).

Se deben considerar situaciones en las cuales una vulnerabilidad a nivel de aplicaciones puede conducir a una penetración de red y viceversa.
El explotar una vulnerabilidad a nivel de un CMS (una aplicación al fin y al cabo) popuede permitir acciones de penetración a nivel de la red interna ( como cuando se abusa de un API RPC [xmlrpc] ).

## Privilege Escalation (Escalamiento de Privilegios)

Es importante indicar que si bien el Escalamiento es un paso que debe realizarse (o cuando menos intentarse), no siempre será requerido para demostrar riesgos críticos.  Por ejemplo, si una vulnerabilidad en una aplicación permite el control total de la misma (mediante una cuenta de usuario supuestamente sin privilegios altos), no importa si no se consigue un acceso a nivel de DBA o SYSTEM/root o desarrollador.

Las formas de escalamiento vertical pueden ser :
- Escalamiento vertical cuando se accede a privilegios de un nivel superior.
- Escalamiento horizontal cuando se accede a privilegios del mismo nivel, pero, de otra identidad.  Esto puede ser util en la medida que, a pesar de tener el mismo tipo de privilegios, pueden ser sobre otros activos de información.

El escalamiento a nivel de infraestructura esta basado en vulnerabilidades locales que pueden implicar el uso de exploits o el abuso de configuraciones erradas o el abuso de procesos o el abuso de aplicaciones ya instaladas.  El principal escollo en estas acciones es la evasión de protecciones locales.

El escalamiento a nivel de aplicaciones esta más orientado a impersonar identidades que cuentan con más privilegios.  Sin embargo, situaciones de procesos de autenticación o controles de acceso o mal manejo de sesiones pueden conducir al escalamiento de privilegios.

Si bien se pueden establecer algunas estrategias respecto a como hacer el escalamiento de privilegios, también es cierto que dependen mucho del conocimiento obtenido luego de la penetración sobre el target específico.

## Elementos empleados durante el TESTING

**Las siguientes secciones involucran elementos que son dependientes de los hallazgos.  Por ende, solamente se referencian elementos que cuentan con la capacidad de ayduar en la comprobación de vulnerabilidades en varios tipos de targets (sistemas operativos/software de base/aplicaciones). De la misma forma, en el caso de aplicaciones, habrán herramientas diversas dependiendo del tipo de pruebas (DAST/SAST/IAST).**

### Fuentes de Exploits

- NMAP (algunos scripts permiten explotar vulnerabilidades como estan)
- Metasploit
- Aquellos que se encuentran en exploit-db
- Aquellos que se encuentran en GitHub ( **revisar al máximo** )

### Explotación usando Credenciales

- NMAP (para ataques de diccionario) o Hydra o Medusa
- Nessus (modificados siempre que se dispongan en formato NASL)
- Nuclei (modificando la forma de validación del template por acciones de ataque)
- Burp (Intruder)
- En redes MS Windows : Responder.py, crackmapexec, Impacket tools, Powersploit
- En APIs : Burp
- En algunos casos de aplicaciones, haciendo uso de automatización de browsers con herramientas como Selenium o realizando instrumentación con herramientas como Frida.
- John the Ripper y/o HashCat

### Escalamiento de Privilegios

- Metasploit
- Burp
- LOLBAS
- GTFOBins
- PEASS-ng
